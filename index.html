<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <title>Staff Attendance with QR</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: Arial,"Noto Sans Khmer",sans-serif; background:#f2f4f7; display:flex; justify-content:center; align-items:flex-start; padding-top:20px; }
        .card { background:#fff; width:100%; max-width:380px; padding:20px; border-radius:14px; box-shadow:0 10px 25px rgba(0,0,0,.1); margin-bottom:20px; }
        h2 { text-align:center; margin-bottom:14px }
        label { font-size:14px; font-weight: bold; }
        input, select, textarea { width:100%; padding:10px; margin:6px 0 12px; border-radius:8px; border:1px solid #ccc; font-size:14px; box-sizing: border-box; }
        textarea { display:none; height: 60px; }
        .time-box { background:#eef2ff; padding:10px; border-radius:8px; text-align:center; font-weight:bold; margin-bottom:12px; }
        button { width:100%; padding:12px; background:#2563eb; color:#fff; border:none; border-radius:10px; font-size:16px; margin-bottom:10px; cursor: pointer; }
        button:active { background: #1e40af; }
        #qrcode { display:flex; justify-content:center; margin-top:10px; }
    </style>
</head>
<body>
<div class="card">
    <h2>ğŸ“‹ Staff Attendance</h2>

    <label>áˆáŸ’á˜áŸ„áŸ‡á–áŸá‰</label>
    <input id="name" placeholder="á”á‰áŸ’á…á¼á›áˆáŸ’á˜áŸ„áŸ‡" required>

    <label>áá½á“á¶á‘á¸</label>
    <input id="role" placeholder="á”á‰áŸ’á…á¼á›áá½á“á¶á‘á¸" required>

    <label>á”áŸ’ášá—áŸá‘</label>
    <select id="type" onchange="checkTime()">
        <option value="checkin">Check-in</option>
        <option value="checkout">Check-out</option>
    </select>

    <div class="time-box" id="timeBox"></div>

    <label id="reasonLabel" style="display:none; color:red;">á˜á¼á›á áŸáá» (á™áºá/á…áŸá‰á˜á»á“)</label>
    <textarea id="reason" placeholder="áŸá¼á˜á”áŸ†á–áŸá‰á˜á¼á›á áŸáá»"></textarea>

    <button onclick="processAttendance()">Generate QR & Send to Telegram</button>

    <div id="qrcode"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
// á€áŸ†áááŸ‹á–áŸááŸŒá˜á¶á“ Telegram
const TELEGRAM_BOT_TOKEN = "8146471538:AAFXcPD4EiNylUbiZUMvghizhfY-NWw3QU8";
const TELEGRAM_CHAT_ID = "1346632543";

const OFFICIAL_IN = "07:15";
const OFFICIAL_OUT = "17:15";

function getNow(){
    const now = new Date();
    const time = now.toTimeString().slice(0,5);
    const date = now.toLocaleDateString("en-GB");
    return {time,date};
}

function checkTime(){
    const {time} = getNow();
    const type = document.getElementById("type").value;
    const reason = document.getElementById("reason");
    const label = document.getElementById("reasonLabel");

    let needReason = false;
    if(type==="checkin" && time > OFFICIAL_IN) needReason=true;
    if(type==="checkout" && time < OFFICIAL_OUT) needReason=true;

    reason.style.display = needReason ? "block" : "none";
    label.style.display = needReason ? "block" : "none";
}

function updateTime(){
    const {time,date} = getNow();
    document.getElementById("timeBox").innerText = `ğŸ•’ ${time} | ğŸ“… ${date}`;
    checkTime();
}
updateTime();
setInterval(updateTime,60000);

// á˜á»áá„á¶ášá•áŸ’á‰á¾áŸá¶ášá‘áŸ… Telegram
async function sendToTelegram(message) {
    const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;
    const params = {
        chat_id: TELEGRAM_CHAT_ID,
        text: message,
        parse_mode: "HTML"
    };

    try {
        await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(params)
        });
    } catch (error) {
        console.error("Error sending to Telegram:", error);
    }
}

function processAttendance() {
    const name = document.getElementById("name").value;
    const role = document.getElementById("role").value;
    const type = document.getElementById("type").value;
    const reason = document.getElementById("reason").value;
    const {time, date} = getNow();

    if(!name || !role){
        alert("áŸá¼á˜á”áŸ†á–áŸá‰áˆáŸ’á˜áŸ„áŸ‡ á“á·á„ áá½á“á¶á‘á¸");
        return;
    }

    // áŸ¡. á”á„áŸ’á€á¾áá¢ááŸ’áá”á‘áŸá˜áŸ’ášá¶á”áŸ‹ QR á“á·á„ Telegram
    let displayText = `<b>Attendance Report</b>\n`;
    displayText += `ğŸ‘¤ Name: ${name}\n`;
    displayText += `ğŸ’¼ Role: ${role}\n`;
    displayText += `Status: ${type === 'checkin' ? 'âœ… Check-in' : 'ğŸšª Check-out'}\n`;
    displayText += `ğŸ“… Date: ${date}\n`;
    displayText += `ğŸ•’ Time: ${time}`;
    if(reason) displayText += `\nâš ï¸ Reason: ${reason}`;

    // áŸ¢. á”á„áŸ’á€á¾á QR Code
    let qrText = `Attendance\nName: ${name}\nRole: ${role}\nType: ${type}\nDate: ${date}\nTime: ${time}`;
    if(reason) qrText += `\nReason: ${reason}`;

    document.getElementById("qrcode").innerHTML="";
    new QRCode(document.getElementById("qrcode"), {
        text: qrText,
        width: 200,
        height: 200,
        colorDark: "#2563eb",
        colorLight: "#ffffff",
        correctLevel: QRCode.CorrectLevel.H
    });

    // áŸ£. á•áŸ’á‰á¾á‘áŸ… Telegram
    sendToTelegram(displayText);
    alert("á‘á·á“áŸ’á“á“áŸá™ááŸ’ášá¼áœá”á¶á“á”á‰áŸ’á‡á¼á“á‘áŸ… Telegram á“á·á„á”á„áŸ’á€á¾á QR ášá½á…ášá¶á›áŸ‹!");
}
</script>
</body>
</html>
